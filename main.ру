import os
import asyncio
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading

# --- –î–ê–ù–ù–´–ï ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'

# –¢–ï–ü–ï–†–¨ –ú–´ –ò–©–ï–ú –¢–ï–ö–°–¢–û–í–£–Æ –°–ï–°–°–ò–Æ
SESSION_STR = os.environ.get('TG_SESSION')
TG_CODE = os.environ.get('TG_CODE')

# –ò—Å–ø–æ–ª—å–∑—É–µ–º StringSession –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)

class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron is running")

def run_web_server():
    server = HTTPServer(('0.0.0.0', 8080), HealthHandler)
    server.serve_forever()

@client.on(events.NewMessage(outgoing=True))
async def action_handler(event):
    if event.raw_text == '.':
        await event.edit("üöÄ **–ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏ –≤–µ—á–Ω–æ!**")

async def main():
    await client.connect()
    
    if not await client.is_user_authorized():
        if not TG_CODE:
            print(">>> –°–ï–°–°–ò–Ø –ù–ï –ù–ê–ô–î–ï–ù–ê. –ó–ê–ü–†–û–° –ö–û–î–ê...")
            await client.send_code_request(PHONE)
            await asyncio.sleep(600)
        else:
            print(f">>> –í–•–û–î –° –ö–û–î–û–ú {TG_CODE}...")
            await client.sign_in(PHONE, TG_CODE.strip())
            # –ì–õ–ê–í–ù–´–ô –ú–û–ú–ï–ù–¢:
            print("\nüÜò –°–ö–û–ü–ò–†–£–ô –≠–¢–£ –°–¢–†–û–ö–£ –ò –í–°–¢–ê–í–¨ –í TG_SESSION –í RENDER: üÜò")
            print(client.session.save())
            print("\n--- –ü–û–°–õ–ï –≠–¢–û–ì–û –ë–û–¢ –ë–û–õ–¨–®–ï –ù–ï –ü–û–ü–†–û–°–ò–¢ –ö–û–î ---")
    else:
        print("‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ü–†–û–®–õ–ê –£–°–ü–ï–®–ù–û (–ß–ï–†–ï–ó TG_SESSION)")

    await client.run_until_disconnected()

if __name__ == '__main__':
    threading.Thread(target=run_web_server, daemon=True).start()
    asyncio.run(main())
