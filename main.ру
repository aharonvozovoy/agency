import os
import asyncio
import datetime
import threading
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv

# --- 1. –§–ò–ö–¢–ò–í–ù–´–ô –°–ï–†–í–ï–† –î–õ–Ø RENDER (–£–±–∏—Ä–∞–µ—Ç –æ—à–∏–±–∫—É –ø–æ—Ä—Ç–∞) ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron is Live")

def run_health_server():
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    server.serve_forever()

# --- 2. –ù–ê–°–¢–†–û–ô–ö–ò –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
API_ID = os.environ.get('API_ID')
API_HASH = os.environ.get('API_HASH')
PHONE = os.environ.get('PHONE_NUMBER') # –î–ª—è WhatsApp

tg_client = TelegramClient('aaron_session', int(API_ID) if API_ID else 0, API_HASH)
stats = {"deals_count": 0, "total_value": 0}

# --- 3. –£–ú–ù–´–ô –ê–ù–ê–õ–ò–ó –î–ï–ù–ï–ì ---
def analyze_deal(text):
    text = text.lower()
    # –¢–≤–æ–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–¥–µ–ª–æ–∫
    prices = {"pcx": 500, "nmax": 500, "forza": 1000, "xmax": 1000, "click": 300}
    for item, price in prices.items():
        if item in text:
            stats["total_value"] += price
            stats["deals_count"] += 1
            return f"üí∞ –°–¥–µ–ª–∫–∞: ~{price} THB ({item})"
    if any(word in text for word in ['price', '—Å–∫–æ–ª—å–∫–æ', '—Ü–µ–Ω–∞', 'rent']):
        return "üí≥ –ö–û–ú–ú–ï–†–ß–ï–°–ö–ò–ô –ó–ê–ü–†–û–°"
    return "üó£ –û–ë–©–ò–ô –í–û–ü–†–û–°"

# --- 4. –û–ë–†–ê–ë–û–¢–ß–ò–ö WHATSAPP ---
def on_wa_message(client, message: MessageEv):
    if not message.Info.FromMe:
        msg_text = message.Message.conversation or ""
        sender = message.Info.PushName or "–ö–ª–∏–µ–Ω—Ç WA"
        status = analyze_deal(msg_text)
        print(f"--- WHATSAPP ANALYTICS ---\nUser: {sender}\nStatus: {status}\nText: {msg_text}")

wa_client = NewClient("db.sqlite3")
wa_client.event_handler.register(MessageEv, on_wa_message)

# --- 5. –û–ë–†–ê–ë–û–¢–ß–ò–ö TELEGRAM ---
@tg_client.on(events.NewMessage)
async def tg_handler(event):
    if not event.out and event.is_private:
        status = analyze_deal(event.raw_text)
        report = f"üïµÔ∏è **–ê–ù–ê–õ–ò–ó TG**\nüìà {status}\nüìù {event.raw_text[:60]}..."
        await tg_client.send_message('me', report)
    elif event.out and '.' in event.raw_text:
        await event.respond("–ê–∞—Ä–æ–Ω –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç... (–ò–ò —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω)")

# --- 6. –ó–ê–ü–£–°–ö –í–°–ï–ì–û ---
async def main():
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    threading.Thread(target=run_health_server, daemon=True).start()
    
    await tg_client.start()
    
    # –ó–∞–ø—É—Å–∫ WhatsApp —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è
    if not wa_client.is_connected():
        print(f"–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï WHATSAPP –î–õ–Ø –ù–û–ú–ï–†–ê: {PHONE}")
        # –ö–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –≤ –ª–æ–≥–∞—Ö Render!
    
    print("AARON SYSTEM: –ü–û–õ–ù–´–ô –ó–ê–ü–£–°–ö")
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
