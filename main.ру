import os, asyncio, threading, re, sys
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv

# --- 1. –°–ï–†–í–ï–† (–ß—Ç–æ–±—ã Render –≤–∏–¥–µ–ª –ø–æ—Ä—Ç 8080) ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron System: Online")

def run_health_server():
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    server.serve_forever()

# --- 2. –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428' # –î–æ–±–∞–≤–∏–ª + –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

# –ù–æ–≤–æ–µ –∏–º—è —Å–µ—Å—Å–∏–∏ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
tg_client = TelegramClient('aaron_final_v3', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

stats = {"dots": 0, "tg_in": 0}

# --- 3. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@tg_client.on(events.NewMessage)
async def handle_tg(event):
    if event.out and event.raw_text.strip() == ".":
        stats["dots"] += 1
        await event.delete()
        await event.respond(f"üìà **–û–¢–ß–ï–¢**\nüìç –¢–æ—á–µ–∫: {stats['dots']}")

# --- 4. –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö ---
async def start_system():
    # –°—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    threading.Thread(target=run_health_server, daemon=True).start()
    print("üåç Health check server started!")

    # –ñ–¥–µ–º –∫–æ–¥ –≤ Environment Variables
    while not os.environ.get('TG_CODE'):
        print("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π TG_CODE...")
        # –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–æ–¥–∞, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        if not hasattr(tg_client, '_code_requested'):
            try:
                await tg_client.connect()
                # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥ (—Å–Ω–∞—á–∞–ª–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ—Ç–æ–º SMS)
                await tg_client.send_code_request(PHONE)
                tg_client._code_requested = True
                print("üì© –ö–æ–¥ –∑–∞–ø—Ä–æ—à–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å Telegram –∏–ª–∏ SMS.")
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        await asyncio.sleep(20)

    # –ö–æ–≥–¥–∞ –∫–æ–¥ –ø–æ—è–≤–∏–ª—Å—è –≤ TG_CODE ‚Äî –≤—Ö–æ–¥–∏–º
    try:
        code = os.environ.get('TG_CODE').strip()
        await tg_client.start(phone=PHONE, code_callback=lambda: code)
        print("‚úÖ Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
        return

    if not wa_client.is_connected():
        wa_client.pair_phone(PHONE)
        
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    try:
        asyncio.run(start_system())
    except KeyboardInterrupt:
        pass
