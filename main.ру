import os
import asyncio
import sys
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from groq import Groq

# --- –ù–ê–°–¢–†–û–ô–ö–ò (–ë–µ—Ä—É—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Render) ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
SESSION_STR = os.environ.get('TELEGRAM_STRING_SESSION')
GROQ_KEY = os.environ.get('GROQ_API_KEY')

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π
if not SESSION_STR or not GROQ_KEY:
    print("‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Render (SESSION –∏ GROQ_API_KEY)!")
    sys.exit(1)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ò–ò –∏ Telegram
ai_client = Groq(api_key=GROQ_KEY)
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)

# –ü–∞–º—è—Ç—å –±–æ—Ç–∞ (—á—Ç–æ–±—ã –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞)
dialog_history = {}

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ò–ò
SYSTEM_PROMPT = """–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä –ê–∞—Ä–æ–Ω. –¢–≤–æ—è —Ü–µ–ª—å: –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑.
–û—Ç–≤–µ—á–∞–π –≤–µ–∂–ª–∏–≤–æ, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É (–º–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—É: '–ò—â—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏)'.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–π –æ–±—Å—É–¥–∏—Ç—å –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.
–ü–∏—à–∏ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –æ–Ω –ø–∏—à–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏ ‚Äî –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –µ—Å–ª–∏ –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏ ‚Äî –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏)."""

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤
KEYWORDS = ['—Ä–∞–±–æ—Ç–∞', '–≤–∞–∫–∞–Ω—Å–∏—è', '–Ω—É–∂–µ–Ω', '–∏—â—É', '—Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ', '–¥–µ–Ω—å–≥–∏', '–æ–ø–ª–∞—Ç–∞', '–∑–∞–∫–∞–∑', '–ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞']
# –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –º—É—Å–æ—Ä
BAD_WORDS = ['–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', '–ø—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞', 'msgwarn', 'id3495']

async def get_ai_response(user_id, user_text):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç —É –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"""
    if user_id not in dialog_history:
        dialog_history[user_id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    
    dialog_history[user_id].append({"role": "user", "content": user_text})
    
    try:
        completion = ai_client.chat.completions.create(
            model="llama3-8b-8192", 
            messages=dialog_history[user_id]
        )
        ai_text = completion.choices[0].message.content
        dialog_history[user_id].append({"role": "assistant", "content": ai_text})
        return ai_text
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ò–ò: {e}")
        return "–ò—â—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏), –≥–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!"

@client.on(events.NewMessage)
async def handler(event):
    try:
        if event.out: return # –ù–µ –æ—Ç–≤–µ—á–∞–µ–º —Å–µ–±–µ

        text = event.raw_text.lower()
        sender = await event.get_sender()
        if not sender: return
        user_id = sender.id

        # –ü—Ä–æ–≤–µ—Ä–∫–∞: –ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –≤ –≥—Ä—É–ø–ø–µ –ò–õ–ò –Ω–∞–º –æ—Ç–≤–µ—Ç–∏–ª–∏ –≤ –ª–∏—á–∫–µ
        is_order = any(word in text for word in KEYWORDS) and not any(bad in text for bad in BAD_WORDS)
        is_private = event.is_private

        if is_order or (is_private and user_id in dialog_history):
            # 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ –ò–ò
            ai_reply = await get_ai_response(user_id, event.raw_text)
            
            # 2. –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–∏–º–∏—Ç–∞—Ü–∏—è —á–µ–ª–æ–≤–µ–∫–∞)
            await asyncio.sleep(4)
            
            # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            await event.reply(ai_reply)

            # 4. –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞
            if hasattr(sender, 'username') and sender.username:
                user_link = f"https://t.me/{sender.username}"
            else:
                user_link = f"tg://user?id={user_id}"

            # 5. –û—Ç—á–µ—Ç –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
            chat_title = event.chat.title if event.chat else "–õ–∏—á–∫–∞"
            await client.send_message('me', 
                f"ü§ñ **–ò–ò –í–°–¢–£–ü–ò–õ –í –î–ò–ê–õ–û–ì!**\n\n"
                f"üìç –ß–∞—Ç: {chat_title}\n"
                f"üë§ –ó–∞–∫–∞–∑—á–∏–∫: {sender.first_name}\n"
                f"üí¨ –¢–≤–æ–π –æ—Ç–≤–µ—Ç: {ai_reply}\n\n"
                f"üîó **–°–í–Ø–ó–ê–¢–¨–°–Ø:** {user_link}")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ: {e}")

async def main():
    await client.start()
    print("üöÄ –£–ú–ù–´–ô –ò–ò-–ê–ì–ï–ù–¢ –ó–ê–ü–£–©–ï–ù")
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
