import os, asyncio, threading, re
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events

# --- –°–ï–†–í–ï–† –î–õ–Ø RENDER ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron Online")

def run_server():
    port = int(os.environ.get("PORT", 8080))
    HTTPServer(('0.0.0.0', port), HealthCheckHandler).serve_forever()

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'

# –ú–µ–Ω—è–µ–º –∏–º—è —Å–µ—Å—Å–∏–∏ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
client = TelegramClient('aaron_cloud_v4', API_ID, API_HASH)

@client.on(events.NewMessage(outgoing=True, pattern=r'^\.$'))
async def handle_dot(event):
    await event.delete()
    await event.respond("üìà **–ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏!**\n–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ–±–ª–∞–∫–µ.")

async def main():
    threading.Thread(target=run_server, daemon=True).start()
    
    await client.connect()
    
    if not await client.is_user_authorized():
        print(f"üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–æ–¥ –¥–ª—è {PHONE}...")
        await client.send_code_request(PHONE)
        
        # –ñ–¥–µ–º, –ø–æ–∫–∞ —Ç—ã –≤–ø–∏—à–µ—à—å –∫–æ–¥ –≤ Render
        while not os.environ.get('TG_CODE'):
            print("‚è≥ –ñ–¥—É –∫–æ–¥ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π TG_CODE –Ω–∞ Render...")
            await asyncio.sleep(15)
        
        try:
            code = os.environ.get('TG_CODE').strip()
            await client.sign_in(PHONE, code)
            print("‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            return

    print("üöÄ –ê–∞—Ä–æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—â–µ–Ω!")
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
