import os
import asyncio
import threading
import re
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv

# --- 1. –°–ï–†–í–ï–† –î–õ–Ø RENDER (–°—Ç–∞—Ç—É—Å Live) ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron Full System: Online")

def run_health_server():
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    server.serve_forever()

# --- 2. –ù–ê–°–¢–†–û–ô–ö–ò (–¢–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ) ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '66618169428'

tg_client = TelegramClient('aaron_session', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

# --- 3. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
stats = {
    "tg_in": 0, "wa_in": 0,
    "dots_count": 0,
    "money_thb": 0, "money_usd": 0,
    "bikes_found": 0
}

def get_ai_level():
    total = stats["tg_in"] + stats["wa_in"]
    if total < 15: return "‚ö° –£—Ä–æ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"
    if total < 50: return "üî• –£—Ä–æ–≤–µ–Ω—å 2: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (–°–¥–µ–ª–∫–∏)"
    return "üíé –£—Ä–æ–≤–µ–Ω—å 3: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ò–ò (–§–∏–Ω-–∫–æ–Ω—Ç—Ä–æ–ª—å)"

def deep_analyze(text):
    text = text.lower()
    
    # –ü–æ–∏—Å–∫ –±–∞–π–∫–æ–≤
    bikes = ["pcx", "nmax", "forza", "xmax", "click", "adv"]
    for bike in bikes:
        if bike in text:
            stats["bikes_found"] += 1

    # –ü–æ–∏—Å–∫ –≤–∞–ª—é—Ç (–ë–∞—Ç—ã –∏ –î–æ–ª–ª–∞—Ä—ã)
    thb = sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|–±–∞—Ç)', text))
    usd = sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd|–¥–æ–ª)', text))
    
    stats["money_thb"] += thb
    stats["money_usd"] += usd
    return thb, usd

# --- 4. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@wa_client.event(MessageEv)
def on_wa_message(client, message: MessageEv):
    msg_text = (message.Message.conversation or "").lower()
    if not message.Info.FromMe:
        stats["wa_in"] += 1
        deep_analyze(msg_text)
    elif msg_text.strip() == ".":
        stats["dots_count"] += 1 # –°—á–∏—Ç–∞–µ–º —Ç–æ—á–∫–∏ –≤ WhatsApp

@tg_client.on(events.NewMessage)
async def on_tg_message(event):
    if not event.out and event.is_private:
        stats["tg_in"] += 1
        deep_analyze(event.raw_text)
    
    elif event.out and event.raw_text.strip() == ".":
        stats["dots_count"] += 1 # –°—á–∏—Ç–∞–µ–º —Ç–æ—á–∫–∏ –≤ Telegram
        await event.delete()
        
        # –í—ã–≤–æ–¥ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å–æ –≤—Å–µ–π –ª–æ–≥–∏–∫–æ–π
        report = (
            f"üìà **–û–¢–ß–ï–¢ –ê–ê–†–û–ù–ê**\n"
            f"üß† {get_ai_level()}\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üìç –¢–≤–æ–∏—Ö —Ç–æ—á–µ–∫: {stats['dots_count']}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏—è: {stats['tg_in'] + stats['wa_in']}\n"
            f"üèç –ë–∞–π–∫–æ–≤ –≤ —á–∞—Ç–∞—Ö: {stats['bikes_found']}\n"
            f"üí∞ –ö–∞—Å—Å–∞ THB: {stats['money_thb']}\n"
            f"üíµ –ö–∞—Å—Å–∞ USD: {stats['money_usd']}\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        )
        await event.respond(report)

# --- 5. –ó–ê–ü–£–°–ö ---
async def start():
    threading.Thread(target=run_health_server, daemon=True).start()
    
    # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∫–æ–¥ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Render
    code_env = os.environ.get('TG_CODE')
    await tg_client.start(phone=PHONE, code_callback=lambda: code_env if code_env else None)
    
    if not wa_client.is_connected():
        wa_client.pair_phone(PHONE)
        
    print("‚úÖ –°–ò–°–¢–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ü–£–©–ï–ù–ê")
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(start())
