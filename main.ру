import os
import asyncio
import sys
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from groq import Groq

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
SESSION_STR = os.environ.get('TELEGRAM_STRING_SESSION')
GROQ_KEY = os.environ.get('GROQ_API_KEY')

if not SESSION_STR or not GROQ_KEY:
    print("‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ SESSION –∏ GROQ_API_KEY –≤ Render!")
    sys.exit(1)

ai_client = Groq(api_key=GROQ_KEY)
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)
dialog_history = {}

# –¢–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
KEYWORDS = [
    '—Ä—ã–±–∞–ª–∫–∞', 'fishing', '–¥–∏–∑–∞–π–Ω', '–ª–æ–≥–æ—Ç–∏–ø', '–±–∞–Ω–Ω–µ—Ä', 
    '–ø–æ–º–æ—â–Ω–∏–∫', '–ø–∞—Ç—Ç–∞–π—è', 'pattaya', '—Ç–∞–∫—Å–∏', '–∞—ç—Ä–æ–ø–æ—Ä—Ç', 
    '–±–∫–∫', 'bkk', '—Å—É–≤–∞—Ä–Ω–∞–±—Ö—É–º–∏', '—Å–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é', '—Å–∫—É—á–Ω–æ'
]

# –§–∏–ª—å—Ç—Ä –º—É—Å–æ—Ä–∞ (—É–±–∏—Ä–∞–µ–º —Ç–æ, —á—Ç–æ –≤–∏–¥–µ–ª –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö: –∏—Å–ø–∞–Ω–∏—è, –∞—Ä–±–∏—Ç—Ä–∞–∂ –∏ —Ç.–¥.)
BAD_WORDS = ['–∏—Å–ø–∞–Ω–∏—è', '–µ–≤—Ä–æ–ø–∞', '–ª–¥–Ω—Ä', '–∞—Ä–±–∏—Ç—Ä–∞–∂', '—Ç—Ä–∞—Ñ–∏–∫', 'ads', 'crypto', '–∫—Ä–∏–ø—Ç–∞']

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ò–ò
SYSTEM_PROMPT = """–¢—ã ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ê–∞—Ä–æ–Ω –≤ –ü–∞—Ç—Ç–∞–π–µ. 
–¢–≤–æ–∏ —É—Å–ª—É–≥–∏: 
1. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ä—ã–±–∞–ª–∫–∏. 
2. –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω (–ª–æ–≥–æ, —Å–∞–π—Ç—ã). 
3. –õ–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –ü–∞—Ç—Ç–∞–π–µ. 
4. –¢–∞–∫—Å–∏ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç (–ë–∞–Ω–≥–∫–æ–∫/–£—Ç–∞–ø–∞–æ). 
5. –°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–∞ –≤–µ—á–µ—Ä (–¥—Ä—É–≥ –Ω–∞ —á–∞—Å).

–¢–≤–æ—è —Ü–µ–ª—å: –∫—Ä–∞—Ç–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Å–ª—É–≥—É –ø–æ–¥ –∑–∞–ø—Ä–æ—Å. 
–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—É: '–ò—â—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏)'.
–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ü—Ä–µ–¥–ª–∞–≥–∞–π –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≤ –ª–∏—á–∫–µ.
–Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —è–∑—ã–∫–æ–º –∫–ª–∏–µ–Ω—Ç–∞."""

async def get_ai_response(user_id, user_text):
    if user_id not in dialog_history:
        dialog_history[user_id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    dialog_history[user_id].append({"role": "user", "content": user_text})
    
    try:
        completion = ai_client.chat.completions.create(
            model="llama3-8b-8192", 
            messages=dialog_history[user_id]
        )
        ai_text = completion.choices[0].message.content
        dialog_history[user_id].append({"role": "assistant", "content": ai_text})
        return ai_text
    except:
        return "–ü—Ä–∏–≤–µ—Ç! –ò—â—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏), –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –≤–∞—à–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –≤ –ü–∞—Ç—Ç–∞–π–µ. –ü–∏—à–∏—Ç–µ –≤ –ª–∏—á–∫—É!"

@client.on(events.NewMessage)
async def handler(event):
    try:
        if event.out: return 

        text = event.raw_text.lower()
        sender = await event.get_sender()
        if not sender: return
        user_id = sender.id

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º—É—Å–æ—Ä–∞
        is_order = any(word in text for word in KEYWORDS) and not any(bad in text for bad in BAD_WORDS)
        is_private = event.is_private

        if is_order or (is_private and user_id in dialog_history):
            ai_reply = await get_ai_response(user_id, event.raw_text)
            
            await asyncio.sleep(3) # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
            await event.reply(ai_reply)

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ç–µ–±—è
            user_link = f"https://t.me/{sender.username}" if hasattr(sender, 'username') and sender.username else f"tg://user?id={user_id}"

            # –û—Ç—á–µ—Ç –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
            chat_title = event.chat.title if event.chat else "–õ–∏—á–∫–∞"
            await client.send_message('me', 
                f"üéØ **–¶–ï–õ–ï–í–û–ô –ó–ê–ö–ê–ó!**\n\n"
                f"üìç –ß–∞—Ç: {chat_title}\n"
                f"üë§ –ö–ª–∏–µ–Ω—Ç: {sender.first_name}\n"
                f"üí¨ –û—Ç–≤–µ—Ç –ò–ò: {ai_reply}\n\n"
                f"üîó **–û–¢–ö–†–´–¢–¨ –î–ò–ê–õ–û–ì:** {user_link}")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")

async def main():
    await client.start()
    print("üöÄ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ò–ò-–ê–ì–ï–ù–¢ (–ü–ê–¢–¢–ê–ô–Ø) –ó–ê–ü–£–©–ï–ù")
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
