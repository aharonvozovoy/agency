import os, asyncio, threading
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from http.server import HTTPServer, BaseHTTPRequestHandler

API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
SESSION_STR = os.environ.get('TG_SESSION')

class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Bot is waiting for session...")

async def main():
    # –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º—Å—è
    if SESSION_STR:
        client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)
        await client.start()
        print("‚úÖ –ê–ê–†–û–ù –ó–ê–ü–£–©–ï–ù –ß–ï–†–ï–ó TG_SESSION")
    else:
        # –ï—Å–ª–∏ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –µ—ë –ø–æ–ª—É—á–µ–Ω–∏—è
        client = TelegramClient(StringSession(), API_ID, API_HASH)
        await client.connect()
        
        print(">>> –®–ê–ì 1: –ó–ê–ü–†–û–° –ö–û–î–ê...")
        sent = await client.send_code_request(PHONE)
        
        print("üÜò –í–ù–ò–ú–ê–ù–ò–ï: –£ —Ç–µ–±—è –µ—Å—Ç—å 5 –º–∏–Ω—É—Ç! üÜò")
        print("1. –î–æ–∂–¥–∏—Å—å –∫–æ–¥ –≤ –¢–ì.")
        print("2. –í–ø–∏—à–∏ –µ–≥–æ –≤ TG_CODE –≤ Render –∏ –Ω–∞–∂–º–∏ Save.")
        
        # –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—ã –ë–ï–ó –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        for _ in range(60): 
            await asyncio.sleep(10)
            check_code = os.environ.get('TG_CODE')
            if check_code:
                print(f">>> –ü–†–û–ë–£–Æ –í–•–û–î –° –ö–û–î–û–ú: {check_code}")
                try:
                    await client.sign_in(PHONE, check_code, phone_code_hash=sent.phone_code_hash)
                    print("\nüî• –£–°–ü–ï–•! –¢–í–û–Ø –°–ï–°–°–ò–Ø –ù–ò–ñ–ï (–°–ö–û–ü–ò–†–£–ô –í–°–Å): üî•")
                    print(client.session.save())
                    print("\n-------------------------------------------")
                    break
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

    @client.on(events.NewMessage(outgoing=True))
    async def handler(event):
        if event.raw_text == '.': await event.edit("üöÄ –ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏!")

    await client.run_until_disconnected()

if __name__ == '__main__':
    threading.Thread(target=lambda: HTTPServer(('0.0.0.0', 8080), HealthHandler).serve_forever(), daemon=True).start()
    asyncio.run(main())
