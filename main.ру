import os
import asyncio
import threading
import re
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv

# --- 1. –°–ï–†–í–ï–† –î–õ–Ø RENDER ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron is Back to Normal")

def run_health_server():
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    server.serve_forever()

# --- 2. –ù–ê–°–¢–†–û–ô–ö–ò (–¢–í–û–ò –ö–õ–Æ–ß–ò) ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = os.environ.get('PHONE_NUMBER', '66618169428')

tg_client = TelegramClient('aaron_session', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

# --- 3. –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–¢–æ—á–∫–∏ + –î–µ–Ω—å–≥–∏ + –°–æ–æ–±—â–µ–Ω–∏—è) ---
stats = {
    "tg_in": 0, "wa_in": 0,
    "dots_count": 0,
    "money_thb": 0, "money_usd": 0
}

def get_ai_level():
    total = stats["tg_in"] + stats["wa_in"]
    if total < 15: return "–£—Ä–æ–≤–µ–Ω—å 1: –ë–∞–∑–∞"
    if total < 50: return "–£—Ä–æ–≤–µ–Ω—å 2: –ê–Ω–∞–ª–∏—Ç–∏–∫"
    return "–£—Ä–æ–≤–µ–Ω—å 3: –ú–∞–∫—Å–∏–º—É–º –ò–ò"

# --- 4. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@wa_client.event(MessageEv)
def on_wa_message(client, message: MessageEv):
    if not message.Info.FromMe:
        stats["wa_in"] += 1
        text = (message.Message.conversation or "").lower()
        # –ü–æ–∏—Å–∫ –¥–µ–Ω–µ–≥
        stats["money_thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|–±–∞—Ç)', text))
        stats["money_usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd)', text))
    elif message.Info.FromMe and message.Message.conversation == ".":
        stats["dots_count"] += 1

@tg_client.on(events.NewMessage)
async def on_tg_message(event):
    if not event.out and event.is_private:
        stats["tg_in"] += 1
        text = event.raw_text.lower()
        stats["money_thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|–±–∞—Ç)', text))
        stats["money_usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd)', text))
    
    elif event.out and event.raw_text == ".":
        stats["dots_count"] += 1
        await event.delete()
        
        report = (
            f"üìà **–û–¢–ß–ï–¢ –ê–ê–†–û–ù–ê**\n"
            f"üß† {get_ai_level()}\n"
            f"üìç –¢–≤–æ–∏—Ö —Ç–æ—á–µ–∫: {stats['dots_count']}\n"
            f"üí¨ –°–æ–æ–±—â–µ–Ω–∏—è: {stats['tg_in'] + stats['wa_in']}\n"
            f"üí∞ –ö–∞—Å—Å–∞: {stats['money_thb']} THB / {stats['money_usd']} USD"
        )
        await event.respond(report)

# --- 5. –ó–ê–ü–£–°–ö ---
async def main():
    threading.Thread(target=run_health_server, daemon=True).start()
    await tg_client.start()
    if not wa_client.is_connected():
        print(f"üì≤ –ö–û–î –î–õ–Ø {PHONE}:")
        wa_client.pair_phone(PHONE)
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
