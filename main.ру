import os, asyncio, threading
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from http.server import HTTPServer, BaseHTTPRequestHandler

# –î–ê–ù–ù–´–ï
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Render
SESSION_STR = os.environ.get('TG_SESSION')
TG_CODE = os.environ.get('TG_CODE')

# –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤–∞—è —Å–µ—Å—Å–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë, –µ—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)

class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Waiting for session string...")

async def main():
    await client.connect()
    
    if not await client.is_user_authorized():
        if not TG_CODE:
            print(">>> –®–ê–ì 1: –ó–ê–ü–†–û–° –ö–û–î–ê. –í–ø–∏—à–∏ –µ–≥–æ –≤ TG_CODE –∏ –Ω–∞–∂–º–∏ Save.")
            await client.send_code_request(PHONE)
            # –ó–∞–º–∏—Ä–∞–µ–º, —á—Ç–æ–±—ã Render –Ω–µ —É–±–∏–ª –ø—Ä–æ—Ü–µ—Å—Å —Å—Ä–∞–∑—É
            await asyncio.sleep(600)
        else:
            print(f">>> –®–ê–ì 2: –í–•–û–î –° –ö–û–î–û–ú {TG_CODE}")
            await client.sign_in(PHONE, TG_CODE.strip())
            print("\nüÜò –°–ö–û–ü–ò–†–£–ô –≠–¢–£ –°–¢–†–û–ö–£ –í TG_SESSION –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°: üÜò")
            print(client.session.save())
            print("\n-------------------------------------------")
    else:
        print("‚úÖ –ë–û–¢ –†–ê–ë–û–¢–ê–ï–¢ –ß–ï–†–ï–ó –°–ï–°–°–ò–Æ!")

    @client.on(events.NewMessage(outgoing=True))
    async def handler(event):
        if event.raw_text == '.': await event.edit("üöÄ –ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏!")

    await client.run_until_disconnected()

if __name__ == '__main__':
    threading.Thread(target=lambda: HTTPServer(('0.0.0.0', 8080), HealthHandler).serve_forever(), daemon=True).start()
    asyncio.run(main())
