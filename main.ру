import os
import asyncio
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading

API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'

# –ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –≥–æ—Ç–æ–≤—É—é —Å–µ—Å—Å–∏—é
SESSION_STR = os.environ.get('TG_SESSION')
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)

class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron is waiting for login...")

async def main():
    await client.connect()
    if not await client.is_user_authorized():
        print(">>> –°–ï–°–°–ò–Ø –ù–ï –ù–ê–ô–î–ï–ù–ê. –ù–ê–ß–ò–ù–ê–Æ –í–•–û–î...")
        # –ú–µ—Ç–æ–¥ start —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç –Ω–∞–ª–∏—á–∏–µ –∫–æ–¥–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç –µ–≥–æ
        # –í–ê–ñ–ù–û: –æ–Ω –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ —Ç—ã –≤–ø–∏—à–µ—à—å –∫–æ–¥ –≤ TG_CODE –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—à—å
        await client.start(phone=PHONE, code_callback=lambda: os.environ.get('TG_CODE'))
        
        print("\nüÜò –£–°–ü–ï–•! –°–ö–û–ü–ò–†–£–ô –≠–¢–£ –°–¢–†–û–ö–£ –í TG_SESSION: üÜò")
        print(client.session.save())
        print("\n-------------------------------------------")
    else:
        print("‚úÖ –ë–û–¢ –ê–í–¢–û–†–ò–ó–û–í–ê–ù –ò –†–ê–ë–û–¢–ê–ï–¢!")

    @client.on(events.NewMessage(outgoing=True))
    async def handler(event):
        if event.raw_text == '.': await event.edit("üöÄ –ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏!")

    await client.run_until_disconnected()

if __name__ == '__main__':
    threading.Thread(target=lambda: HTTPServer(('0.0.0.0', 8080), HealthHandler).serve_forever(), daemon=True).start()
    asyncio.run(main())
