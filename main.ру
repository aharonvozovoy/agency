# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–µ–ø–µ—Ä—å —Ç—Ä–∏–≥–≥–µ—Ä ‚Äî —ç—Ç–æ –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏ –≤ —Ç–≤–æ–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
# (–Ω–æ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, —á—Ç–æ–±—ã –±–æ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –æ—Ç 3 —Ç–æ—á–µ–∫)

async def get_ai_response(user_text, relevance_level, history):
    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫
    if relevance_level >= 5:
        style = "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, –≤–µ–∂–ª–∏–≤–æ –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ. –≠—Ç–æ VIP –∫–ª–∏–µ–Ω—Ç. –ó–∞–∫—Ä—ã–≤–∞–π —Å–¥–µ–ª–∫—É –ª—é–±–æ–π —Ü–µ–Ω–æ–π."
    elif relevance_level >= 3:
        style = "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å. –ß–µ—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ."
    else:
        style = "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ –∏ –±—ã—Å—Ç—Ä–æ. –û–¥–∏–Ω-–¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."

    prompt = f"–¢—ã ‚Äî –ê–∞—Ä–æ–Ω, —ç–∫—Å–ø–µ—Ä—Ç –≤ –ü–∞—Ç—Ç–∞–π–µ. {style} –¢–µ–º—ã: —Ä—ã–±–∞–ª–∫–∞, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã, –±–∞–π–∫–∏, –≤–∏–∑—ã."
    
    messages = [{"role": "system", "content": prompt}]
    for msg in history:
        role = "assistant" if msg.out else "user"
        # –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –ò–ò –Ω–µ –∑–∞–ø—É—Ç–∞–ª—Å—è
        clean_text = msg.text.replace('.', '') if msg.text else ""
        messages.append({"role": role, "content": clean_text})
    
    try:
        completion = ai_client.chat.completions.create(model="llama3-8b-8192", messages=messages)
        return completion.choices[0].message.content
    except:
        return "–°–µ–∫—É–Ω–¥—É, —Å–µ–π—á–∞—Å —É—Ç–æ—á–Ω—é –¥–µ—Ç–∞–ª–∏..."

@client.on(events.NewMessage)
async def handler(event):
    try:
        if not event.is_private: return # –†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–∫–µ
        
        sender = await event.get_sender()
        text = event.raw_text
        
        # –ï—Å–ª–∏ –¢–´ –ø–∏—à–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
        if event.out:
            dot_count = text.count('.') # –°—á–∏—Ç–∞–µ–º —Ç–æ—á–∫–∏
            
            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ò–ò, –µ—Å–ª–∏ –≤ —Ç–≤–æ–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç 1 –¥–æ 5 —Ç–æ—á–µ–∫
            if 1 <= dot_count <= 5:
                # –ë–µ—Ä–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                history = await client.get_messages(event.chat_id, limit=10)
                
                # –ó–∞–ø—É—Å–∫–∞–µ–º –ò–ò —Å —É—á–µ—Ç–æ–º —É—Ä–æ–≤–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫)
                ai_reply = await get_ai_response("–ü—Ä–æ–¥–æ–ª–∂–∏", dot_count, history[::-1])
                
                await asyncio.sleep(2) # –ü–∞—É–∑–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
                await event.respond(ai_reply)
                
                # –û—Ç—á–µ—Ç –¥–ª—è —Ç–µ–±—è –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                await client.send_message('me', f"ü§ñ **–ò–ò –≤–∫–ª—é—á–µ–Ω (–£—Ä–æ–≤–µ–Ω—å {dot_count})**\n–ö–æ–Ω—Ç–µ–∫—Å—Ç: {sender.first_name}")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
