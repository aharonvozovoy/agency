import os
import asyncio
from telethon import TelegramClient
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading

# ОБНОВЛЕННЫЕ ДАННЫЕ
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428' # Твой актуальный номер

# Код подтверждения берем из переменной TG_CODE в Render
TG_CODE = os.environ.get('TG_CODE')

client = TelegramClient('session_aaron', API_ID, API_HASH)

# Заглушка для порта Render
def run_port_server():
    try:
        server = HTTPServer(('0.0.0.0', 10000), type('H', (BaseHTTPRequestHandler,), {'do_GET': lambda s: (s.send_response(200), s.end_headers())}))
        server.serve_forever()
    except: pass

async def main():
    print("--- ЗАПУСК СИСТЕМЫ (AARON) ---")
    await client.connect()

    if not await client.is_user_authorized():
        # Если кода в Render нет — запрашиваем
        if not TG_CODE or TG_CODE.strip() == "":
            print(f">>> ОТПРАВЛЯЮ ЗАПРОС НА НОМЕР: {PHONE}")
            try:
                await client.send_code_request(PHONE)
                print("✅ КОД ОТПРАВЛЕН! Проверь свой Telegram.")
            except Exception as e:
                print(f"❌ Ошибка запроса: {e}")
        else:
            # Если ты уже вписал код в Render — входим
            try:
                print(f">>> ПРОБУЮ ВОЙТИ С КОДОМ: {TG_CODE}")
                await client.sign_in(PHONE, TG_CODE.strip())
                print("✅✅✅ УСПЕХ! Аарон активен и готов к работе.")
            except Exception as e:
                print(f"❌ Ошибка входа: {e}")
                print("Совет: Очисти TG_CODE в Render, нажми Save и попробуй заново.")
    else:
        print("✅ СТАТУС: Бот уже авторизован и работает!")

    while True: await asyncio.sleep(1000)

if __name__ == '__main__':
    threading.Thread(target=run_port_server, daemon=True).start()
    asyncio.run(main())
