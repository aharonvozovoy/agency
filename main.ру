import os
import asyncio
import sys
from telethon import TelegramClient, events
from telethon.sessions import StringSession

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
SESSION_STR = os.environ.get('TELEGRAM_STRING_SESSION')

# –¢–≤–æ–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –≤ —á–∞—Ç
MY_REPLY = "–ò—â—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏), —á—Ç–æ –º–æ–∂–µ—Ç–µ –º–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å?"

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
KEYWORDS = ['—Ä–∞–±–æ—Ç–∞', '–≤–∞–∫–∞–Ω—Å–∏—è', '–Ω—É–∂–µ–Ω', '–∏—â—É', '—Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ', '–¥–µ–Ω—å–≥–∏', '–æ–ø–ª–∞—Ç–∞', '–∑–∞–∫–∞–∑', '–ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞']
BAD_WORDS = ['–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', '–ø—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞', 'id3495', 'msgwarn']

if not SESSION_STR:
    print("‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SESSION –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
    sys.exit(1)

client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)

@client.on(events.NewMessage)
async def handler(event):
    try:
        if event.out: return # –ù–µ –æ—Ç–≤–µ—á–∞–µ–º —Å–µ–±–µ

        text = event.raw_text.lower()
        
        if any(word in text for word in KEYWORDS) and not any(bad in text for bad in BAD_WORDS):
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            sender = await event.get_sender()
            sender_id = sender.id
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É: –µ—Å–ª–∏ –µ—Å—Ç—å username ‚Äî –ø–æ –Ω–µ–º—É, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ ID
            if hasattr(sender, 'username') and sender.username:
                user_link = f"https://t.me/{sender.username}"
            else:
                user_link = f"tg://user?id={sender_id}"
            
            await asyncio.sleep(3) # –ó–∞–¥–µ—Ä–∂–∫–∞ 3 —Å–µ–∫—É–Ω–¥—ã
            
            # 1. –û—Ç–≤–µ—á–∞–µ–º –≤ —á–∞—Ç (—Ä–µ–ø–ª–∞–µ–º)
            await event.reply(MY_REPLY)
            
            # 2. –ü–∏—à–µ–º —Ç–µ–±–µ –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ª–∏—á–∫—É
            chat_title = event.chat.title if event.chat else "–õ–∏—á–Ω—ã–π —á–∞—Ç"
            
            await client.send_message('me', 
                f"üí∞ **–ù–ê–ô–î–ï–ù –ó–ê–ö–ê–ó –ò –û–¢–ü–†–ê–í–õ–ï–ù –û–¢–í–ï–¢!**\n\n"
                f"üìç **–ß–∞—Ç:** {chat_title}\n"
                f"üë§ **–ó–∞–∫–∞–∑—á–∏–∫:** {sender.first_name if hasattr(sender, 'first_name') else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}\n"
                f"üìù **–¢–µ–∫—Å—Ç:** {event.raw_text[:200]}...\n\n"
                f"üîó **–ù–ê–ü–ò–°–ê–¢–¨ –í –õ–ò–ß–ö–£:** {user_link}\n\n"
                f"üöÄ –î–µ–π—Å—Ç–≤—É–π –±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ—Ö!")
            
            print(f"‚úÖ –û—Ç–≤–µ—Ç–∏–ª –∏ –ø—Ä–∏—Å–ª–∞–ª —Å—Å—ã–ª–∫—É. –ß–∞—Ç: {chat_title}")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")

async def main():
    await client.start()
    print("üöÄ –ë–û–¢-–ê–í–¢–û–û–¢–í–ï–¢–ß–ò–ö –° –°–´–õ–ö–ê–ú–ò –ó–ê–ü–£–©–ï–ù")
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
