import os
import asyncio
import sys
from telethon import TelegramClient, events
from telethon.sessions import StringSession

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
# –ë–µ—Ä–µ–º —Å–µ—Å—Å–∏—é –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
SESSION_STR = os.environ.get('TELEGRAM_STRING_SESSION')

# –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤
KEYWORDS = ['–Ω—É–∂–µ–Ω', '–∑–∞–∫–∞–∑', '–¥–∏–∑–∞–π–Ω', '–ª–æ–≥–æ—Ç–∏–ø', '—Å–∞–π—Ç', '–≤–µ—Ä—Å—Ç–∫–∞', '–±–æ—Ç']

# –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø—É—Å—Ç–∞—è, –±–æ—Ç –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∏ –∏ –Ω–µ –±—É–¥–µ—Ç –ø—Ä–æ—Å–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
if not SESSION_STR:
    print("‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TELEGRAM_STRING_SESSION –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Render!")
    sys.exit(1)

# –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)

@client.on(events.NewMessage)
async def handler(event):
    try:
        text = event.raw_text.lower()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        if any(word in text for word in KEYWORDS):
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–µ–±–µ –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" (Saved Messages)
            chat_title = event.chat.title if event.chat else "–õ–∏—á–Ω—ã–π —á–∞—Ç"
            await client.send_message('me', 
                f"üí∞ **–ù–ê–ô–î–ï–ù –ó–ê–ö–ê–ó!**\n\n"
                f"üìç –ò—Å—Ç–æ—á–Ω–∏–∫: {chat_title}\n"
                f"üìù –¢–µ–∫—Å—Ç: {event.raw_text[:500]}...\n\n"
                f"üöÄ –ü–æ—Å–ø–µ—à–∏ –∑–∞–±—Ä–∞—Ç—å!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

async def main():
    print("üì° –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram...")
    try:
        # –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (StringSession –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
        await client.start()
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏
        me = await client.get_me()
        print(f"‚úÖ –£–°–ü–ï–•! –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –ø–æ–¥ –∞–∫–∫–∞—É–Ω—Ç–æ–º: {me.first_name}")
        print("üöÄ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω. –û–∂–∏–¥–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...")
        
        # –†–∞–±–æ—Ç–∞–µ–º –¥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        await client.run_until_disconnected()
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")

if __name__ == '__main__':
    # –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        pass
