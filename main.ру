import os
import asyncio
import threading
import http.server
import socketserver
from telethon import TelegramClient, events
from telethon.sessions import StringSession
from groq import Groq

# --- –°–ï–†–í–ï–† –î–õ–Ø –°–¢–ê–¢–£–°–ê LIVE ---
def run_health_check():
    port = int(os.environ.get("PORT", 8080))
    handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", port), handler) as httpd:
        httpd.serve_forever()

threading.Thread(target=run_health_check, daemon=True).start()

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
SESSION_STR = os.environ.get('TELEGRAM_STRING_SESSION')
GROQ_KEY = os.environ.get('GROQ_API_KEY')

ai_client = Groq(api_key=GROQ_KEY)
client = TelegramClient(StringSession(SESSION_STR), API_ID, API_HASH)
dialog_history = {}

# –í–µ—Ç–∫–∞ 1: –û–±—â–∏–µ —É—Å–ª—É–≥–∏
WORK_KEYWORDS = ['—Ä—ã–±–∞–ª–∫–∞', 'fishing', '–¥–∏–∑–∞–π–Ω', '–ª–æ–≥–æ—Ç–∏–ø', '—Ç–∞–∫—Å–∏', '–∞—ç—Ä–æ–ø–æ—Ä—Ç', '–±–∫–∫']
# –í–µ—Ç–∫–∞ 2: –î–ª—è –¥–µ–≤—É—à–µ–∫ (VIP —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ)
GIRLS_KEYWORDS = ['—Å–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é', '—Å–∫—É—á–Ω–æ', '–∏—â—É –ø–∞—Ä–Ω—è', '–ø—Ä–æ–≥—É–ª–∫–∞', '—É–∂–∏–Ω', '–≤–µ—á–µ—Ä']

BAD_WORDS = ['–∏—Å–ø–∞–Ω–∏—è', '–µ–≤—Ä–æ–ø–∞', '–∞—Ä–±–∏—Ç—Ä–∞–∂', '—Ç—Ä–∞—Ñ–∏–∫', 'crypto', '–≤–∞–ª—é—Ç–∞']

# –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
WORK_PROMPT = "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ê–∞—Ä–æ–Ω. –£—Å–ª—É–≥–∏: —Ä—ã–±–∞–ª–∫–∞, –¥–∏–∑–∞–π–Ω, —Ç–∞–∫—Å–∏. –§—Ä–∞–∑–∞: '–ò—â—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏)'. –ö—Ä–∞—Ç–∫–æ."
GIRLS_PROMPT = "–¢—ã ‚Äî –≥–∞–ª–∞–Ω—Ç–Ω—ã–π —Å–ø—É—Ç–Ω–∏–∫ –ê–∞—Ä–æ–Ω. –£—Å–ª—É–≥–∏: —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –¥–ª—è –¥–∞–º, —É–∂–∏–Ω, –ø—Ä–æ–≥—É–ª–∫–∏. –§—Ä–∞–∑–∞: '–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é —É—Å–ª—É–≥–∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –Ω–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –æ—Å–Ω–æ–≤–µ (—Ü–µ–Ω—é —Å–≤–æ–µ –≤—Ä–µ–º—è –∏ –≤–∞—à –∫–æ–º—Ñ–æ—Ä—Ç)'. –°—Ç–∏–ª—å: –≤–µ–∂–ª–∏–≤—ã–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π."

async def get_ai_response(user_id, user_text, is_girl_request):
    prompt = GIRLS_PROMPT if is_girl_request else WORK_PROMPT
    if user_id not in dialog_history:
        dialog_history[user_id] = [{"role": "system", "content": prompt}]
    
    dialog_history[user_id].append({"role": "user", "content": user_text})
    completion = ai_client.chat.completions.create(model="llama3-8b-8192", messages=dialog_history[user_id])
    ai_text = completion.choices[0].message.content
    dialog_history[user_id].append({"role": "assistant", "content": ai_text})
    return ai_text

@client.on(events.NewMessage)
async def handler(event):
    try:
        if event.out: return 
        sender = await event.get_sender()
        if not sender: return
        text = event.raw_text.lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ç–∫—É
        is_girl_req = any(word in text for word in GIRLS_KEYWORDS)
        is_work_req = any(word in text for word in WORK_KEYWORDS)
        is_bad = any(bad in text for bad in BAD_WORDS)

        if not event.is_private and (is_girl_req or is_work_req) and not is_bad:
            ai_reply = await get_ai_response(sender.id, event.raw_text, is_girl_req)
            await asyncio.sleep(3)
            await event.reply(ai_reply)

        elif event.is_private:
            # –í –ª–∏—á–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é, –∫–∞–∫–∞—è –≤–µ—Ç–∫–∞ –±—ã–ª–∞ –Ω–∞—á–∞—Ç–∞
            ai_reply = await get_ai_response(sender.id, event.raw_text, is_girl_req)
            await asyncio.sleep(2)
            await event.respond(ai_reply)
            
            user_link = f"https://t.me/{sender.username}" if hasattr(sender, 'username') and sender.username else f"tg://user?id={sender.id}"
            tag = "üíé VIP –î–ï–í–£–®–ö–ê" if is_girl_req else "üõ† –ó–ê–ö–ê–ó"
            
            await client.send_message('me', f"üî• **{tag} –í –õ–ò–ß–ö–ï!**\n\nüë§: {sender.first_name}\nüí¨: {event.raw_text}\nü§ñ: {ai_reply}\n\nüîó **–û–¢–ö–†–´–¢–¨:** {user_link}")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")

async def main():
    await client.start()
    print("üöÄ –ì–ò–ë–†–ò–î–ù–´–ô –ë–û–¢ –ó–ê–ü–£–©–ï–ù")
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
