import os, asyncio, threading, re
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv
from openai import OpenAI

# --- 1. Ğ¡Ğ•Ğ Ğ’Ğ•Ğ  Ğ”Ğ›Ğ¯ RENDER (Ğ—Ğ°Ğ¿ÑƒÑĞº ĞŸĞ•Ğ Ğ’Ğ«Ğœ) ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron System: Online and Waiting for Code")

def run_health_server():
    # Render Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ñ€Ñ‚
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    print(f"ğŸŒ Health check server started on port {port}")
    server.serve_forever()

# --- 2. ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '66618169428'

# Ğ“Ñ€Ğ¾Ğº
XAI_API_KEY = os.environ.get("XAI_API_KEY")
client_grok = OpenAI(api_key=XAI_API_KEY, base_url="https://api.x.ai/v1")

tg_client = TelegramClient('aaron_session', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

stats = {"tg_in": 0, "wa_in": 0, "dots": 0, "thb": 0, "usd": 0, "bikes": 0}

# --- 3. Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞĞĞ›Ğ˜Ğ—Ğ ---
def deep_analyze(text):
    text = text.lower()
    bikes = ["pcx", "nmax", "forza", "xmax", "click", "adv"]
    for bike in bikes:
        if bike in text: stats["bikes"] += 1
    stats["thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|Ğ±Ğ°Ñ‚)', text))
    stats["usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd|Ğ´Ğ¾Ğ»)', text))

# --- 4. ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ (Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ) ---
@wa_client.event(MessageEv)
def on_wa(client, message: MessageEv):
    text = (message.Message.conversation or "").strip()
    if not message.Info.FromMe:
        stats["wa_in"] += 1
        deep_analyze(text)
    elif text == ".":
        stats["dots"] += 1

@tg_client.on(events.NewMessage)
async def on_tg(event):
    if event.out and event.raw_text.strip() == ".":
        stats["dots"] += 1
        await event.delete()
        lvl = "ğŸ’ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 3" if stats["tg_in"] > 50 else "âš¡ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 1"
        report = (
            f"ğŸ“ˆ **ĞĞ¢Ğ§Ğ•Ğ¢ ĞĞĞ ĞĞĞ**\nğŸ§  {lvl}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ğŸ“ Ğ¢Ğ²Ğ¾Ğ¸Ñ… Ñ‚Ğ¾Ñ‡ĞµĞº: {stats['dots']}\n"
            f"ğŸ’° ĞšĞ°ÑÑĞ°: {stats['thb']} THB / {stats['usd']} USD\n"
            f"ğŸ Ğ‘Ğ°Ğ¹ĞºĞ¾Ğ²: {stats['bikes']}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        await event.respond(report)
    elif not event.out and event.is_private:
        stats["tg_in"] += 1
        deep_analyze(event.raw_text)

# --- 5. Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ Ğ—ĞĞŸĞ£Ğ¡Ğš ---
async def start_system():
    # Ğ¨ĞĞ“ 1: Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Render Ğ½Ğµ Ğ²Ñ‹Ğ´Ğ°Ğ²Ğ°Ğ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¿Ğ¾Ñ€Ñ‚Ğ°
    threading.Thread(target=run_health_server, daemon=True).start()
    
    print("â³ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½. ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° TG_CODE Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Render...")
    
    # Ğ¨ĞĞ“ 2: Ğ–Ğ´ĞµĞ¼ ĞºĞ¾Ğ´ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    while not os.environ.get('TG_CODE'):
        await asyncio.sleep(15)
    
    # Ğ¨ĞĞ“ 3: ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    try:
        await tg_client.start(phone=PHONE, code_callback=lambda: os.environ.get('TG_CODE'))
        print("âœ… Telegram Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½!")
    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°: {e}")
        return

    if not wa_client.is_connected():
        print(f"ğŸ“² ĞšĞĞ” WHATSAPP Ğ”Ğ›Ğ¯ {PHONE}...")
        wa_client.pair_phone(PHONE)
        
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(start_system())
