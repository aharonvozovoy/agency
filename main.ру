import os
import asyncio
from telethon import TelegramClient, events
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading

# --- –¢–í–û–ò –î–ê–ù–ù–´–ï ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'

# –ë–µ—Ä–µ–º –∫–æ–¥ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Render
TG_CODE = os.environ.get('TG_CODE')

# –ù–æ–≤–æ–µ –∏–º—è —Å–µ—Å—Å–∏–∏ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
client = TelegramClient('session_v2', API_ID, API_HASH)

# –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Render (–ø–æ—Ä—Ç 8080)
class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron is alive")
    def log_message(self, format, *args): return

def run_web_server():
    port = 8080
    server = HTTPServer(('0.0.0.0', port), HealthHandler)
    print(f"--- –í–ï–ë-–°–ï–†–í–ï–† –ü–û–î–ù–Ø–¢ –ù–ê –ü–û–†–¢–£ {port} ---")
    server.serve_forever()

# –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô
@client.on(events.NewMessage(outgoing=True))
async def action_handler(event):
    if event.raw_text == '.':
        print(">>> –¢–û–ß–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê!")
        await event.edit("üöÄ **–ê–∞—Ä–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!**\n–°–µ—Å—Å–∏—è v2 –∞–∫—Ç–∏–≤–Ω–∞.")

async def main():
    print("--- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö TELEGRAM ---")
    await client.connect()
    
    authorized = await client.is_user_authorized()
    
    if not authorized:
        if not TG_CODE or TG_CODE.strip() == "":
            print(">>> –®–ê–ì 1: –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ù–û–í–´–ô –∫–æ–¥ –≤ Telegram...")
            await client.send_code_request(PHONE)
            print("‚úÖ –ö–û–î –û–¢–ü–†–ê–í–õ–ï–ù! –í–ø–∏—à–∏ –µ–≥–æ –≤ TG_CODE –≤ Render –∏ –Ω–∞–∂–º–∏ Save.")
        else:
            print(f">>> –®–ê–ì 2: –ü—Ä–æ–±—É—é –≤–æ–π—Ç–∏ —Å –∫–æ–¥–æ–º: {TG_CODE}")
            try:
                await client.sign_in(PHONE, TG_CODE.strip())
                print("‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! –ê–∞—Ä–æ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.")
            except Exception as e:
                print(f"‚ùå –û–®–ò–ë–ö–ê –í–•–û–î–ê: {e}")
                print("–°–æ–≤–µ—Ç: –û—á–∏—Å—Ç–∏ TG_CODE –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.")
                return
    else:
        print("‚úÖ –ë–û–¢ –£–ñ–ï –í –°–ï–¢–ò")

    await client.run_until_disconnected()

if __name__ == '__main__':
    threading.Thread(target=run_web_server, daemon=True).start()
    asyncio.run(main())
