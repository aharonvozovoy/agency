import os
import asyncio
import threading
import http.server
import socketserver
import imaplib
import smtplib
import email
import time
import requests
from email.mime.text import MIMEText

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ç–æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ NameError
import telethon
from telethon import TelegramClient, events, errors

from groq import Groq

# --- 1. HEALTH CHECK –î–õ–Ø RENDER ---
def run_health_check():
    port = int(os.environ.get("PORT", 8080))
    handler = http.server.SimpleHTTPRequestHandler
    socketserver.TCPServer.allow_reuse_address = True
    try:
        with socketserver.TCPServer(("", port), handler) as httpd:
            print(f"Health check on port {port}")
            httpd.serve_forever()
    except Exception as e:
        print(f"Health check error: {e}")

threading.Thread(target=run_health_check, daemon=True).start()

# --- 2. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
SESSION_STR = os.environ.get('TELEGRAM_STRING_SESSION')
GROQ_KEY = os.environ.get('GROQ_API_KEY')
WHAPI_TOKEN = os.environ.get('WHAPI_TOKEN') # –¢–æ—Ç —Å–∞–º—ã–π —Ç–æ–∫–µ–Ω —Å–æ —Å–∫—Ä–∏–Ω–∞

EMAIL_USER = os.environ.get('EMAIL_USER')
EMAIL_PASS = os.environ.get('EMAIL_PASS')

ai_client = Groq(api_key=GROQ_KEY)
tg_client = TelegramClient(telethon.sessions.StringSession(SESSION_STR), API_ID, API_HASH)

dialog_history = {}

# --- 3. –õ–û–ì–ò–ö–ê –ò –ü–†–û–ú–ü–¢–´ ---
WORK_KEYWORDS = ['—Ä—ã–±–∞–ª–∫–∞', 'fishing', '–¥–∏–∑–∞–π–Ω', '–ª–æ–≥–æ—Ç–∏–ø', '—Ç–∞–∫—Å–∏', '–∞—ç—Ä–æ–ø–æ—Ä—Ç']
GIRLS_KEYWORDS = ['—Å–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é', '—Å–∫—É—á–Ω–æ', '–ø—Ä–æ–≥—É–ª–∫–∞', '—É–∂–∏–Ω', '–≤–µ—á–µ—Ä']

WORK_PROMPT = "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ê–∞—Ä–æ–Ω. –£—Å–ª—É–≥–∏: —Ä—ã–±–∞–ª–∫–∞, –¥–∏–∑–∞–π–Ω. –§—Ä–∞–∑–∞: '–ò—â—É –∑–∞—Ä–∞–±–æ—Ç–æ–∫ (–Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏)'."
GIRLS_PROMPT = "–¢—ã ‚Äî –≥–∞–ª–∞–Ω—Ç–Ω—ã–π –ê–∞—Ä–æ–Ω. –£—Å–ª—É–≥–∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è. –§—Ä–∞–∑–∞: '–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é —É—Å–ª—É–≥–∏ –Ω–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –æ—Å–Ω–æ–≤–µ'."

async def get_ai_response(user_id, user_text):
    text_l = user_text.lower()
    is_girl = any(word in text_l for word in GIRLS_KEYWORDS)
    prompt = GIRLS_PROMPT if is_girl else WORK_PROMPT
    
    if user_id not in dialog_history:
        dialog_history[user_id] = [{"role": "system", "content": prompt}]
    
    dialog_history[user_id].append({"role": "user", "content": user_text})
    
    try:
        completion = ai_client.chat.completions.create(
            model="llama3-8b-8192", 
            messages=dialog_history[user_id]
        )
        ai_text = completion.choices[0].message.content
        return ai_text, is_girl
    except Exception as e:
        print(f"AI Error: {e}")
        return "–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏ –≤ –ª–∏—á–∫–µ.", is_girl

# --- 4. WHATSAPP (WHAPI) ---
def wa_loop():
    if not WHAPI_TOKEN:
        print("WA: No Token")
        return
    
    print("üì≤ WhatsApp (Whapi) Monitoring Started")
    last_msg_id = None
    headers = {"Authorization": f"Bearer {WHAPI_TOKEN}"}
    
    while True:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            r = requests.get("https://gate.whapi.cloud/messages?limit=1", headers=headers).json()
            if 'messages' in r and r['messages']:
                msg = r['messages'][0]
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
                if msg.get('from_me') or msg.get('id') == last_msg_id:
                    time.sleep(3)
                    continue
                
                last_msg_id = msg.get('id')
                chat_id = msg.get('chat_id')
                text = msg.get('text', {}).get('body')

                if text:
                    reply_text, _ = asyncio.run(get_ai_response(chat_id, text))
                    requests.post(
                        "https://gate.whapi.cloud/messages/text",
                        json={"to": chat_id, "body": reply_text},
                        headers=headers
                    )
        except Exception as e:
            print(f"WA Error: {e}")
        time.sleep(5)

# --- 5. GMAIL ---
def email_loop():
    if not EMAIL_USER or not EMAIL_PASS:
        print("Email: No Credentials")
        return
    
    print("üìß Gmail Monitoring Started")
    while True:
        try:
            mail = imaplib.IMAP4_SSL("imap.gmail.com")
            mail.login(EMAIL_USER, EMAIL_PASS)
            mail.select("inbox")
            _, data = mail.search(None, 'UNSEEN')
            
            for num in data[0].split():
                _, msg_data = mail.fetch(num, '(RFC822)')
                msg = email.message_from_bytes(msg_data[0][1])
                sender = email.utils.parseaddr(msg['From'])[1]
                subject = msg.get('Subject', '')
                
                reply_text, _ = asyncio.run(get_ai_response(sender, subject))
                
                with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
                    smtp.login(EMAIL_USER, EMAIL_PASS)
                    res = MIMEText(reply_text)
                    res['Subject'] = f"Re: {subject}"
                    res['To'] = sender
                    res['From'] = EMAIL_USER
                    smtp.sendmail(EMAIL_USER, sender, res.as_string())
        except Exception as e:
            print(f"Email Error: {e}")
        time.sleep(30)

# --- 6. TELEGRAM ---
@tg_client.on(events.NewMessage)
async def handle_tg(event):
    if event.out: return
    try:
        sender = await event.get_sender()
        reply, is_girl = await get_ai_response(sender.id, event.raw_text)
        await event.respond(reply)

# –ù–∞—Ö–æ–¥–∏–º —ç—Ç–æ—Ç –±–ª–æ–∫ –≤ handle_tg –∏ –∑–∞–º–µ–Ω—è–µ–º:
        tag = "üíé VIP" if is_girl else "üõ† –ó–ê–ö–ê–ó"
        
        # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_link = f"[{sender.first_name}](tg://user?id={sender.id})"
        if sender.username:
            user_link = f"[@{sender.username}](https://t.me/{sender.username})"

        await tg_client.send_message('me', f"üî• {tag}\nüë§: {user_link}\nüí¨: {event.raw_text}", link_preview=True)


#       tag = "üíé VIP" if is_girl else "üõ† –ó–ê–ö–ê–ó"
#      await tg_client.send_message('me', f"üî• {tag}\nüë§: {sender.first_name}\nüí¨: {event.raw_text}")
    except errors.rpcerrorlist.SlowModeWaitError:
        print("Slow mode active")
    except Exception as e:
        print(f"TG Error: {e}")

# --- 7. –ó–ê–ü–£–°–ö ---
if __name__ == '__main__':
    threading.Thread(target=wa_loop, daemon=True).start()
    threading.Thread(target=email_loop, daemon=True).start()
    print("üöÄ Bot Starting...")
    tg_client.start()
    tg_client.run_until_disconnected()
