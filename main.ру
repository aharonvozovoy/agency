import os, asyncio, threading, re
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv
from openai import OpenAI
from googleapiclient.discovery import build

def run_health_server():
    # Render ÑĞ°Ğ¼ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ñ€Ñ‚, Ğ½Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ
    port = int(os.environ.get("PORT", 8080)) 
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    print(f"ğŸŒ Health check server started on port {port}")
    server.serve_forever()

async def start_system():
    # 1. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Render ÑƒÑĞ¿Ğ¾ĞºĞ¾Ğ¸Ğ»ÑÑ
    threading.Thread(target=run_health_server, daemon=True).start()
    print("ğŸŒ Health check server started!")

    # 2. Ğ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¶Ğ´ĞµĞ¼ ĞºĞ¾Ğ´
    while not os.environ.get('TG_CODE'):
        print("â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ² Render...")
        await asyncio.sleep(20)
    
    # ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ´ ...



# --- ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ (Ğ¢Ğ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ) ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '66618169428'

# Ğ“Ğ ĞĞš (xAI) - ĞšĞ»ÑÑ‡ Ğ±ĞµÑ€ĞµĞ¼ Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Render
XAI_API_KEY = os.environ.get("XAI_API_KEY")
client_grok = OpenAI(api_key=XAI_API_KEY, base_url="https://api.x.ai/v1")

tg_client = TelegramClient('aaron_session', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

# Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° (Ğ¢Ğ¾Ñ‡ĞºĞ¸, Ğ”ĞµĞ½ÑŒĞ³Ğ¸, Ğ‘Ğ°Ğ¹ĞºĞ¸)
stats = {
    "tg_in": 0, "wa_in": 0, 
    "dots_count": 0, 
    "money_thb": 0, "money_usd": 0,
    "bikes_found": 0
}

# Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‚ĞµĞºÑÑ‚Ğ°
def deep_analyze(text):
    text = text.lower()
    # ĞŸĞ¾Ğ¸ÑĞº Ğ±Ğ°Ğ¹ĞºĞ¾Ğ²
    bikes = ["pcx", "nmax", "forza", "xmax", "click", "adv"]
    for bike in bikes:
        if bike in text: stats["bikes_found"] += 1
    # Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ²Ğ°Ğ»ÑÑ‚
    stats["money_thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|Ğ±Ğ°Ñ‚)', text))
    stats["money_usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd|Ğ´Ğ¾Ğ»)', text))

# --- ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ WHATSAPP ---
@wa_client.event(MessageEv)
def on_wa_message(client, message: MessageEv):
    msg_text = (message.Message.conversation or "").strip()
    if not message.Info.FromMe:
        stats["wa_in"] += 1
        deep_analyze(msg_text)
    elif msg_text == ".":
        stats["dots_count"] += 1 # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ² WA

# --- ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ TELEGRAM ---
@tg_client.on(events.NewMessage)
async def on_tg_message(event):
    msg_text = event.raw_text.strip()
    
    # Ğ•ÑĞ»Ğ¸ Ñ‚Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» Ñ‚Ğ¾Ñ‡ĞºÑƒ "."
    if event.out and msg_text == ".":
        stats["dots_count"] += 1
        await event.delete()
        
        # Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ˜Ğ˜
        lvl = "ğŸ’ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 3: ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼" if stats["tg_in"] > 50 else "âš¡ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ 1: Ğ‘Ğ°Ğ·Ğ°"
        
        report = (
            f"ğŸ“ˆ **ĞĞ¢Ğ§Ğ•Ğ¢ ĞĞĞ ĞĞĞ**\n"
            f"ğŸ§  {lvl}\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ğŸ“ Ğ¢Ğ²Ğ¾Ğ¸Ñ… Ñ‚Ğ¾Ñ‡ĞµĞº: {stats['dots_count']}\n"
            f"ğŸ’¬ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {stats['tg_in'] + stats['wa_in']}\n"
            f"ğŸ’° ĞšĞ°ÑÑĞ°: {stats['money_thb']} THB / {stats['money_usd']} USD\n"
            f"ğŸ Ğ‘Ğ°Ğ¹ĞºĞ¾Ğ²: {stats['bikes_found']}\n"
            f"ğŸ“§ Gmail: ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        await event.respond(report)
        
    elif not event.out and event.is_private:
        stats["tg_in"] += 1
        deep_analyze(msg_text)

# --- Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« ---
async def start_aaron():
    # Ğ–Ğ´ĞµĞ¼ Ğ²Ğ²Ğ¾Ğ´Ğ° ĞºĞ¾Ğ´Ğ° Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ TG_CODE, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Render Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ»
    while not os.environ.get('TG_CODE'):
        print("â³ Aaron Ğ¶Ğ´ĞµÑ‚ ĞºĞ¾Ğ´ Ğ² Environment Variables...")
        await asyncio.sleep(20)
        
    await tg_client.start(phone=PHONE, code_callback=lambda: os.environ.get('TG_CODE'))
    
    if not wa_client.is_connected():
        print(f"ğŸ“² Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ ĞšĞĞ”Ğ WHATSAPP...")
        wa_client.pair_phone(PHONE)
        
    print("âœ… Ğ’Ğ¡Ğ• Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« Ğ—ĞĞŸĞ£Ğ©Ğ•ĞĞ«")
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(start_aaron())
