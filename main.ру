import os
import asyncio
from telethon import TelegramClient, events
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading

# --- –î–ê–ù–ù–´–ï ---
API_ID = 30893125
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '+66618169428'
TG_CODE = os.environ.get('TG_CODE')

client = TelegramClient('session_v3', API_ID, API_HASH)

class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Waiting for code...")
    def log_message(self, format, *args): return

def run_web_server():
    server = HTTPServer(('0.0.0.0', 8080), HealthHandler)
    server.serve_forever()

@client.on(events.NewMessage(outgoing=True))
async def action_handler(event):
    if event.raw_text == '.':
        await event.edit("üöÄ **–ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏!**")

async def main():
    print("--- –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ ---")
    await client.connect()
    
    if not await client.is_user_authorized():
        if not TG_CODE:
            print(">>> –®–ê–ì 1: –ó–ê–ü–†–û–° –ö–û–î–ê (–û–î–ù–û–ö–†–ê–¢–ù–û) <<<")
            await client.send_code_request(PHONE)
            print("‚úÖ –ö–û–î –û–¢–ü–†–ê–í–õ–ï–ù! –£ —Ç–µ–±—è –µ—Å—Ç—å 10 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –≤–≤–µ—Å—Ç–∏ –µ–≥–æ –≤ TG_CODE.")
            # –ó–ê–ú–ò–†–ê–ï–ú, —á—Ç–æ–±—ã Render –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª –±–æ—Ç–∞
            await asyncio.sleep(600) 
        else:
            print(f">>> –®–ê–ì 2: –í–•–û–î –° –ö–û–î–û–ú {TG_CODE} <<<")
            try:
                await client.sign_in(PHONE, TG_CODE.strip())
                print("‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! –ë–û–¢ –ê–í–¢–û–†–ò–ó–û–í–ê–ù.")
            except Exception as e:
                print(f"‚ùå –û–®–ò–ë–ö–ê: {e}. –û—á–∏—Å—Ç–∏ TG_CODE –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.")
    else:
        print("‚úÖ –ë–û–¢ –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢")

    await client.run_until_disconnected()

if __name__ == '__main__':
    threading.Thread(target=run_web_server, daemon=True).start()
    asyncio.run(main())
