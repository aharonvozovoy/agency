import os
import asyncio
from telethon import TelegramClient, events

# –¢–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Render Environment Variables
API_ID = os.environ.get('API_ID')
API_HASH = os.environ.get('API_HASH')
SESSION_STRING = os.environ.get('SESSION_STRING')

client = TelegramClient('aaron_session', API_ID, API_HASH)

# --- –ë–õ–û–ö –£–ú–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê ---
async def get_ai_analysis(messages):
    # –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò –¥–ª—è –∫—Ä–∞—Ç–∫–æ–π —Å–≤–æ–¥–∫–∏
    # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—É—Ç –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ —Ç–≤–æ–µ–≥–æ GPT-–ø—Ä–æ–º–ø—Ç–∞
    context = " ".join([m.text for m in messages if m.text][-3:])
    return {
        "summary": f"–ö–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è: '{context[:50]}...'",
        "advice": "–ü–æ—Å—Ç–∞–≤—å . –¥–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ ... –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."
    }

@client.on(events.NewMessage)
async def handler(event):
    chat_id = event.chat_id
    
    # 1. –ï–°–õ–ò –ü–ò–®–ï–¢ –ö–õ–ò–ï–ù–¢ (–í—Ö–æ–¥—è—â–µ–µ)
    if not event.out and event.is_private:
        # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
        history = await client.get_messages(chat_id, limit=5)
        client_msgs = [m for m in history if not m.out]
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ—Ä–∏–∏ –∏–ª–∏ –∏—Ö —É–∂–µ –º–Ω–æ–≥–æ ‚Äî —à–ª–µ–º –ø—É—à-–∞–Ω–∞–ª–∏–∑
        if len(client_msgs) == 1 or len(client_msgs) == 4:
            analysis = await get_ai_analysis(client_msgs)
            report = (
                f"üéØ **–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å!**\n"
                f"üìù {analysis['summary']}\n"
                f"üî• –°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥: {len(client_msgs)}\n"
                f"üí° {analysis['advice']}"
            )
            await client.send_message('me', report) # –®–ª–µ–º –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"

    # 2. –ï–°–õ–ò –¢–´ –°–¢–ê–í–ò–®–¨ –¢–û–ß–ö–£ (–¢–≤–æ–π —Ç—Ä–∏–≥–≥–µ—Ä)
    elif event.out and '.' in event.raw_text:
        dot_count = event.raw_text.count('.')
        if 1 <= dot_count <= 10:
            # –ë–µ—Ä–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
            history = await client.get_messages(chat_id, limit=10)
            
            # –°–æ–æ–±—â–∞–µ–º, —á—Ç–æ –ò–ò –Ω–∞—á–∞–ª –¥—É–º–∞—Ç—å (–∏–º–∏—Ç–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏)
            async with client.action(chat_id, 'typing'):
                # –°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –ê–∞—Ä–æ–Ω–∞
                # –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ (dot_count) –∏ –Ω–∞–ø–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
                response = "–ê–∞—Ä–æ–Ω –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç... (–∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ò–ò)" 
                
                await asyncio.sleep(2) # –ü–∞—É–∑–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
                await event.respond(response)
                await client.send_message('me', f"‚úÖ –û—Ç–≤–µ—Ç–∏–ª –∫–ª–∏–µ–Ω—Ç—É (–£—Ä–æ–≤–µ–Ω—å {dot_count})")

async def main():
    await client.start()
    print("–ê–∞—Ä–æ–Ω –≤ —Ä–µ–∂–∏–º–µ Smart Live!") # –≠—Ç–æ —É–≤–∏–¥–∏—à—å –≤ –ª–æ–≥–∞—Ö Render
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
