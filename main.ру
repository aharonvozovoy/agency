import os
import asyncio
import datetime
from telethon import TelegramClient, events

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–ï–†–ï–ú–ï–ù–ù–´–• (–ë–µ—Ä—É—Ç—Å—è –∏–∑ Render) ---
API_ID = int(os.environ.get('API_ID', 0))
API_HASH = os.environ.get('API_HASH', '')
SESSION_STRING = os.environ.get('SESSION_STRING', '')

client = TelegramClient('aaron_session', API_ID, API_HASH)

# --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–õ–Ø –û–¢–ß–ï–¢–ê ---
stats = {
    "deals_count": 0,
    "total_value": 0,
    "hot_clients": set()
}

# --- –§–£–ù–ö–¶–ò–Ø –§–ò–ù–ê–ù–°–û–í–û–ì–û –ê–ù–ê–õ–ò–ó–ê ---
def analyze_money(text):
    text = text.lower()
    # –°–ª–æ–≤–∞—Ä—å —Ü–µ–Ω –¥–ª—è –ü–∞—Ç—Ç–∞–π–∏ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–¥ —Å–µ–±—è)
    prices = {"pcx": 500, "nmax": 500, "forza": 1000, "xmax": 1000, "click": 300}
    
    # –ü–æ–∏—Å–∫ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
    commercial_triggers = ['rent', 'buy', 'price', 'cost', '—Å–∫–æ–ª—å–∫–æ', '—Ü–µ–Ω–∞', '–∞—Ä–µ–Ω–¥–∞']
    is_commercial = any(word in text for word in commercial_triggers)
    
    if is_commercial:
        # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—ã–π —á–µ–∫
        for bike, price in prices.items():
            if bike in text:
                stats["total_value"] += price # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â—É—é –∫–∞—Å—Å—É –¥–Ω—è
                return f"üí∞ –°–¥–µ–ª–∫–∞: ~{price} THB (–∑–∞ —Å—É—Ç–∫–∏ {bike})"
        
        if 'month' in text or '–º–µ—Å—è—Ü' in text:
            stats["total_value"] += 5000 # –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∑–∞ –º–µ—Å—è—Ü
            return "üíé –ö–†–£–ü–ù–ê–Ø –°–î–ï–õ–ö–ê: –î–æ–ª–≥–æ—Å—Ä–æ–∫"
            
        return "üí≥ –ö–û–ú–ú–ï–†–ß–ï–°–ö–ò–ô –ó–ê–ü–†–û–°"
    
    return "üó£ –û–ë–©–ò–ô –í–û–ü–†–û–°"

# --- –ï–ñ–ï–î–ù–ï–í–ù–´–ô –û–¢–ß–ï–¢ (–í 21:00) ---
async def daily_report_task():
    while True:
        now = datetime.datetime.now()
        if now.hour == 21 and now.minute == 0:
            report = (
                f"üìä **–ò–¢–û–ì–ò –î–ù–Ø (AARON BI)**\n\n"
                f"‚úÖ –ó–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats['deals_count']}\n"
                f"üí∞ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–∞—Å—Å—ã: {stats['total_value']} THB\n"
                f"üî• –ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤: {len(stats['hot_clients'])}\n\n"
                f"--- \n"
                f"–°–∏—Å—Ç–µ–º–∞ Live. –ñ–¥—É –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤! üöÄ"
            )
            await client.send_message('me', report)
            # –°–±—Ä–æ—Å –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å
            stats["deals_count"] = 0
            stats["total_value"] = 0
            stats["hot_clients"].clear()
            await asyncio.sleep(65) 
        await asyncio.sleep(30)

# --- –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô ---
@client.on(events.NewMessage)
async def handler(event):
    chat_id = event.chat_id
    
    # 1. –ê–ù–ê–õ–ò–ó –í–•–û–î–Ø–©–ò–• (–û–¢ –ö–õ–ò–ï–ù–¢–ê)
    if not event.out and event.is_private:
        text = event.raw_text
        stats["deals_count"] += 1
        stats["hot_clients"].add(chat_id)
        
        # –°—á–∏—Ç–∞–µ–º –Ω–∞–ø–æ—Ä (—Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥)
        history = await client.get_messages(chat_id, limit=5)
        client_msgs = [m for m in history if not m.out]
        pressure_level = len(client_msgs)
        
        # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        money_status = analyze_money(text)
        
        # –ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
        report = (
            f"üïµÔ∏è **–ê–ê–†–û–ù-–ê–ù–ê–õ–ò–¢–ò–ö**\n"
            f"üë§ –ö–ª–∏–µ–Ω—Ç: {event.sender.first_name if event.sender else 'Unknown'}\n"
            f"üìà –°—Ç–∞—Ç—É—Å: {money_status}\n"
            f"‚ö°Ô∏è –ù–∞–ø–æ—Ä: {pressure_level} —Å–æ–æ–±—â.\n"
            f"üìù –°—É—Ç—å: {text[:80]}...\n\n"
            f"üëâ –ü–æ—Å—Ç–∞–≤—å —Ç–æ—á–∫—É –¥–ª—è –æ—Ç–≤–µ—Ç–∞."
        )
        await client.send_message('me', report)

    # 2. –¢–í–û–ô –¢–†–ò–ì–ì–ï–† (–¢–û–ß–ö–ò)
    elif event.out and '.' in event.raw_text:
        dot_count = event.raw_text.count('.')
        if 1 <= dot_count <= 10:
            # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –ò–ò
            async with client.action(chat_id, 'typing'):
                # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ —Ç–≤–æ–µ–π LLM (Gemini/GPT)
                # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É, –∏–º–∏—Ç–∏—Ä—É—é—â—É—é —Ä–∞–±–æ—Ç—É –ê–∞—Ä–æ–Ω–∞
                response = f"–ê–∞—Ä–æ–Ω –≤ –¥–µ–ª–µ. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é ({dot_count} —É—Ä.)..."
                
                await asyncio.sleep(1.5) # –ü–∞—É–∑–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
                await event.respond(response)
                await client.send_message('me', f"‚úÖ –ò–ò –æ—Ç–≤–µ—Ç–∏–ª –≤ —á–∞—Ç (–£—Ä–æ–≤–µ–Ω—å {dot_count})")

# --- –ó–ê–ü–£–°–ö ---
async def main():
    await client.start()
    print("AARON BI: –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ Smart Live")
    asyncio.create_task(daily_report_task())
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
