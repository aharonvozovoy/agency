import os, asyncio, threading, re
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv
from openai import OpenAI

# --- 1. –°–ï–†–í–ï–† –î–õ–Ø RENDER (–ó–∞–ø—É—Å–∫ –ü–ï–†–í–´–ú) ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron System: Online and Waiting for Code")

def run_health_server():
    # Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ—Ä—Ç
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    print(f"üåç Health check server started on port {port}")
    server.serve_forever()

# --- 2. –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '66618169428'

# –ì—Ä–æ–∫
XAI_API_KEY = os.environ.get("XAI_API_KEY")
client_grok = OpenAI(api_key=XAI_API_KEY, base_url="https://api.x.ai/v1")

tg_client = TelegramClient('aaron_new_start', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

stats = {"tg_in": 0, "wa_in": 0, "dots": 0, "thb": 0, "usd": 0, "bikes": 0}

# --- 3. –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê ---
def deep_analyze(text):
    text = text.lower()
    bikes = ["pcx", "nmax", "forza", "xmax", "click", "adv"]
    for bike in bikes:
        if bike in text: stats["bikes"] += 1
    stats["thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|–±–∞—Ç)', text))
    stats["usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd|–¥–æ–ª)', text))

# --- 4. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (–¢–æ—á–∫–∏ –∏ –°–æ–æ–±—â–µ–Ω–∏—è) ---
@wa_client.event(MessageEv)
def on_wa(client, message: MessageEv):
    text = (message.Message.conversation or "").strip()
    if not message.Info.FromMe:
        stats["wa_in"] += 1
        deep_analyze(text)
    elif text == ".":
        stats["dots"] += 1

@tg_client.on(events.NewMessage)
async def on_tg(event):
    if event.out and event.raw_text.strip() == ".":
        stats["dots"] += 1
        await event.delete()
        lvl = "üíé –£—Ä–æ–≤–µ–Ω—å 3" if stats["tg_in"] > 50 else "‚ö° –£—Ä–æ–≤–µ–Ω—å 1"
        report = (
            f"üìà **–û–¢–ß–ï–¢ –ê–ê–†–û–ù–ê**\nüß† {lvl}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üìç –¢–≤–æ–∏—Ö —Ç–æ—á–µ–∫: {stats['dots']}\n"
            f"üí∞ –ö–∞—Å—Å–∞: {stats['thb']} THB / {stats['usd']} USD\n"
            f"üèç –ë–∞–π–∫–æ–≤: {stats['bikes']}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        )
        await event.respond(report)
    elif not event.out and event.is_private:
        stats["tg_in"] += 1
        deep_analyze(event.raw_text)

# --- 5. –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö ---
async def start_system():
    # –®–ê–ì 1: –°—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã Render –Ω–µ –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É –ø–æ—Ä—Ç–∞
    threading.Thread(target=run_health_server, daemon=True).start()
    
    print("‚è≥ –°–µ—Ä–≤–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–¥–∞ TG_CODE –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Render...")
    
    # –®–ê–ì 2: –ñ–¥–µ–º –∫–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    while not os.environ.get('TG_CODE'):
        await asyncio.sleep(15)
    
    # –®–ê–ì 3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        # –®–ê–ì 3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (—Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –∫–æ–¥–∞)
    try:
        # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º force_sms=True, —á—Ç–æ–±—ã Telegram –≤—ã—Å–ª–∞–ª SMS, –µ—Å–ª–∏ —á–∞—Ç –º–æ–ª—á–∏—Ç
        await tg_client.sign_in(phone=PHONE) 
        print("üì≤ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å —á–∞—Ç Telegram –∏–ª–∏ SMS.")
        
        while not os.environ.get('TG_CODE'):
            await asyncio.sleep(10)
            
        await tg_client.start(phone=PHONE, code_callback=lambda: os.environ.get('TG_CODE'))
        print("‚úÖ Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: {e}")
