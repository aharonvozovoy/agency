import os
import asyncio
import threading
import re
from http.server import HTTPServer, BaseHTTPRequestHandler
from telethon import TelegramClient, events
from neonize.client import NewClient
from neonize.events import MessageEv

# --- 1. –°–ï–†–í–ï–† ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Aaron System Live")

def run_health_server():
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    server.serve_forever()

# --- 2. –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = 30893125 
API_HASH = '5c73de68f3152f0513292cb495071e0b'
PHONE = '66618169428'

tg_client = TelegramClient('aaron_session', API_ID, API_HASH)
wa_client = NewClient("db.sqlite3")

stats = {"tg_in": 0, "wa_in": 0, "dots_count": 0, "money_thb": 0, "money_usd": 0}

# --- 3. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (–¢–æ—á–∫–∏, –ë–∞—Ç—ã, –î–æ–ª–ª–∞—Ä—ã, –£—Ä–æ–≤–Ω–∏) ---
@wa_client.event(MessageEv)
def on_wa_message(client, message: MessageEv):
    msg_text = (message.Message.conversation or "").lower()
    if not message.Info.FromMe:
        stats["wa_in"] += 1
        stats["money_thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|–±–∞—Ç)', msg_text))
        stats["money_usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd)', msg_text))
    elif msg_text.strip() == ".":
        stats["dots_count"] += 1

@tg_client.on(events.NewMessage)
async def on_tg_message(event):
    if not event.out and event.is_private:
        stats["tg_in"] += 1
        text = event.raw_text.lower()
        stats["money_thb"] += sum(int(m[0]) for m in re.findall(r'(\d{2,6})\s?(thb|–±–∞—Ç)', text))
        stats["money_usd"] += sum(int(m[0]) for m in re.findall(r'(\d{1,5})\s?(\$|usd)', text))
    elif event.out and event.raw_text.strip() == ".":
        stats["dots_count"] += 1
        await event.delete()
        total = stats["tg_in"] + stats["wa_in"]
        lvl = "1: –ë–∞–∑–∞" if total < 15 else "2: –ê–Ω–∞–ª–∏—Ç–∏–∫" if total < 50 else "3: –ú–∞–∫—Å –ò–ò"
        report = (f"üìà **–û–¢–ß–ï–¢ –ê–ê–†–û–ù–ê**\nüß† {lvl}\nüìç –¢–æ—á–µ–∫: {stats['dots_count']}\n"
                  f"üí∞ –ö–∞—Å—Å–∞: {stats['money_thb']} THB / {stats['money_usd']} USD")
        await event.respond(report)

# --- 4. –ó–ê–ü–£–°–ö (–ë–ï–ó –í–ò–°–Ø–ö–û–í) ---
async def start():
    threading.Thread(target=run_health_server, daemon=True).start()
    
    # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∫–æ–¥ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Render, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
    code_from_env = os.environ.get('TG_CODE')
    
    await tg_client.start(
        phone=PHONE,
        code_callback=lambda: code_from_env if code_from_env else input("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥: ")
    )
    
    if not wa_client.is_connected():
        wa_client.pair_phone(PHONE)
        
    print("‚úÖ –°–ò–°–¢–ï–ú–ê –ê–ê–†–û–ù –ó–ê–ü–£–©–ï–ù–ê")
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(start())
