import os
import asyncio
from telethon import TelegramClient, events

# –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Render
API_ID = os.environ.get('TG_API_ID')
API_HASH = os.environ.get('TG_API_HASH')
PHONE = os.environ.get('TG_PHONE')
TG_CODE = os.environ.get('TG_CODE')

client = TelegramClient('session_aaron', API_ID, API_HASH)

async def main():
    print("--- –ê–∞—Ä–æ–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è ---")
    
    await client.connect()
    
    if not await client.is_user_authorized():
        print(f"–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–æ–º–µ—Ä–∞: {PHONE}")
        
        # –ï—Å–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π TG_CODE –ø—É—Å—Ç–æ, –º—ã –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º –∏ –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥
        if not TG_CODE or TG_CODE == "":
            print("–û–ñ–ò–î–ê–ù–ò–ï: –í–ø–∏—à–∏ –∫–æ–¥ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é TG_CODE –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Render –∏ –Ω–∞–∂–º–∏ Deploy.")
            return # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏
        
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–π—Ç–∏ —Å —Ç–µ–º –∫–æ–¥–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –≤–ø–∏—Å–∞–ª
            await client.sign_in(PHONE, TG_CODE)
            print("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ (–≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–¥ —É—Å—Ç–∞—Ä–µ–ª): {e}")
            # –ï—Å–ª–∏ –∫–æ–¥ –Ω–µ –ø–æ–¥–æ—à–µ–ª, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ù–û–í–´–ô —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            await client.send_code_request(PHONE)
            print("‚ö†Ô∏è –ó–∞–ø—Ä–æ—à–µ–Ω –ù–û–í–´–ô –∫–æ–¥. –ü–æ–ª—É—á–∏ –µ–≥–æ –≤ Telegram, –æ–±–Ω–æ–≤–∏ TG_CODE –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ Deploy.")
            return

    print("üöÄ –ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏ –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    
    @client.on(events.NewMessage(pattern=r'^\.$', outgoing=True))
    async def handler(event):
        await event.delete()
        await event.respond("‚úÖ –ê–∞—Ä–æ–Ω –≤ —Å–µ—Ç–∏! –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ–±–ª–∞–∫–µ.")

    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
