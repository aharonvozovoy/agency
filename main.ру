import os
import asyncio
import datetime
from telethon import TelegramClient, events
# –î–ª—è WhatsApp –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É neonize (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —ç–º—É–ª—è—Ü–∏—è)
from neonize.client import NewClient
from neonize.events import ConnectedEv, MessageEv

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_ID = int(os.environ.get('API_ID', 0))
API_HASH = os.environ.get('API_HASH', '')
SESSION_STRING = os.environ.get('SESSION_STRING', '')

tg_client = TelegramClient('aaron_session', API_ID, API_HASH)
stats = {"deals_count": 0, "total_value": 0, "hot_clients": set()}

# --- –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê (–û–ë–©–ê–Ø) ---
def analyze_request(text):
    text = text.lower()
    prices = {"pcx": 500, "nmax": 500, "forza": 1000, "xmax": 1000, "click": 300}
    for item, price in prices.items():
        if item in text:
            stats["total_value"] += price
            return f"üí∞ –°–¥–µ–ª–∫–∞: ~{price} THB ({item})"
    return "üí≥ –ö–û–ú–ú–ï–†–ß–ï–°–ö–ò–ô –ó–ê–ü–†–û–°" if "price" in text or "—Å–∫–æ–ª—å–∫–æ" in text else "üó£ –û–ë–©–ò–ô –í–û–ü–†–û–°"

# --- WHATSAPP –ß–ê–°–¢–¨ ---
def on_whatsapp_message(client, message: MessageEv):
    if not message.Info.FromMe:
        text = message.Message.conversation or ""
        sender = message.Info.PushName or "–ö–ª–∏–µ–Ω—Ç WA"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats["deals_count"] += 1
        status = analyze_request(text)
        
        # –®–ª–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (–ò–∑–±—Ä–∞–Ω–Ω–æ–µ)
        report = (
            f"üü¢ **WHATSAPP –ó–ê–ü–†–û–°**\n"
            f"üë§ {sender}\n"
            f"üìà {status}\n"
            f"üìù {text[:80]}...\n"
            f"üëâ –ü–æ—Å—Ç–∞–≤—å . –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å–∫–æ—Ä–æ –Ω–∞—Å—Ç—Ä–æ–∏–º –º–æ—Å—Ç)"
        )
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ TG –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (—Ç—Ä–µ–±—É–µ—Ç asyncio –º–æ—Å—Ç–∞)
        print(f"WA MESSAGE: {text}") 

wa_client = NewClient("db.sqlite3")
wa_client.event_handler.register(MessageEv, on_whatsapp_message)

# --- TELEGRAM –ß–ê–°–¢–¨ ---
@tg_client.on(events.NewMessage)
async def tg_handler(event):
    if not event.out and event.is_private:
        stats["deals_count"] += 1
        status = analyze_request(event.raw_text)
        report = f"üîµ **TELEGRAM –ó–ê–ü–†–û–°**\nüìà {status}\nüìù {event.raw_text[:80]}..."
        await tg_client.send_message('me', report)
    
    elif event.out and '.' in event.raw_text:
        # –õ–æ–≥–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò (–∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ)
        await event.respond("–ê–∞—Ä–æ–Ω –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç...")

# --- –ó–ê–ü–£–°–ö ---
async def main():
    await tg_client.start()
    
    # –ó–∞–ø—É—Å–∫ WhatsApp —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è (–≤—ã–≤–µ–¥–µ—Ç –∫–æ–¥ –≤ –ª–æ–≥–∞—Ö)
    if not wa_client.is_connected():
        # –ú–µ—Ç–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –ø–æ –Ω–æ–º–µ—Ä—É (Phone Pairing)
        # –ù–æ–º–µ—Ä –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ Render
        phone = os.environ.get('PHONE_NUMBER') 
        print(f"–ó–∞–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–¥ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –¥–ª—è {phone} –≤ –ª–æ–≥–∞—Ö –Ω–∏–∂–µ!")
    
    asyncio.create_task(daily_report_task()) # –°–≤–æ–¥–∫–∞ –≤ 21:00
    await tg_client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())
